import React, { useEffect, useState, useRef } from "react";
import { createClient } from "@supabase/supabase-js";
import "./Message.css";

const supabaseUrl = "https://vlowdzoigoyaudsydqam.supabase.co";
const supabaseKey =
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZsb3dkem9pZ295YXVkc3lkcWFtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDM0MDg3NTUsImV4cCI6MjA1ODk4NDc1NX0.7ltcwu8G4_awXU5SFkAXRGnSeThjTTqAOVUm1bjtmnU";
const supabase = createClient(supabaseUrl, supabaseKey);

export default function Message() {
  const [username, setUsername] = useState("이예도");
  const [message, setMessage] = useState("");
  const [messages, setMessages] = useState([]);
  const messageRef = useRef(null);

  // 메시지 불러오기
  const fetchMessages = async () => {
    const { data, error } = await supabase
      .from("messages")
      .select("*")
      .order("time", { ascending: true });

    if (error) {
      console.error("메시지 불러오기 실패:", error.message);
    } else {
      setMessages(data);
    }
  };

  // 메시지 보내기
  const sendMessage = async () => {
    if (!username || !message) return;
    const { error } = await supabase.from("messages").insert([
      {
        name: username,
        message: message,
      },
    ]);
    if (error) {
      console.error("메시지 전송 실패:", error.message);
    }
    setMessage("");
  };

  // 실시간 업데이트 설정
  useEffect(() => {
    fetchMessages();

    // 실시간 수신 로직
    supabase
      .channel("realtime-messages")
      .on(
        "postgres_changes",
        {
          event: "INSERT",
          schema: "public",
          table: "messages",
        },
        (payload) => {
          if (!payload.new.time) {
            fetchMessages();
          } else {
            setMessages((prev) => [...prev, payload.new]);
          }
        }
      )
      .subscribe();
  }, []);

  useEffect(() => {
    messageRef.current?.scrollIntoView({ behavior: "smooth" });
  }, [messages]);

  return (
    <div className="MainBackground">
      <div className="messagesList">
        {messages.map((msg) => (
          <div key={msg.id}>
            <div className="message">
              <img
                className="profileIcon"
                style={{ width: "40px", height: "30px" }}
                src="./images/discord.png"
              />
              <div className="messageData">
                <div className="nametime">
                  <p className="name">{msg.name}</p>
                  <p className="time">
                    {msg.time && new Date(msg.time).toTimeString().slice(0, 5)}
                  </p>
                </div>
                <p className="text">{msg.message}</p>
              </div>
            </div>
          </div>
        ))}
        <div ref={messageRef} />
      </div>

      <div className="inputBar">
        <svg
          aria-hidden="true"
          role="img"
          xmlns="http://www.w3.org/2000/svg"
          width="20"
          height="20"
          fill="none"
          viewBox="0 0 24 24"
        >
          <circle cx="12" cy="12" r="10" fill="transparent" />
          <path
            fill="#99aab5"
            d="M12 23a11 11 0 1 0 0-22 11 11 0 0 0 0 22Zm0-17a1 1 0 0 1 1 1v4h4a1 1 0 1 1 0 2h-4v4a1 1 0 1 1-2 0v-4H7a1 1 0 1 1 0-2h4V7a1 1 0 0 1 1-1Z"
          />
        </svg>

        <input
          className="input"
          type="text"
          placeholder="메시지를 입력하세요"
          value={message}
          onChange={(e) => setMessage(e.target.value)}
          onKeyDown={(e) => {
            if (e.key === "Enter") sendMessage();
          }}
        />

        <svg
          width="22"
          height="22"
          viewBox="0 0 60 60"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            fill-rule="evenodd"
            clip-rule="evenodd"
            d="M42.2201 20.6143H50.0051C52.7651 20.6143 55.0051 22.8719 55.0051 25.6479V30.6814H5.00513V25.6479C5.00513 22.8719 7.24763 20.6143 10.0051 20.6143H17.7901C16.6626 20.0229 15.5951 19.3005 14.7026 18.4046C11.7776 15.4599 11.7776 10.6705 14.7026 7.72841C17.5351 4.8769 22.4701 4.8769 25.3076 7.72338C29.4001 11.8433 29.9526 19.5975 30.0001 20.4683C30.0029 20.4973 29.9966 20.5232 29.9904 20.549C29.9851 20.5703 29.9801 20.5915 29.9801 20.6143H30.0301C30.0301 20.5913 30.0249 20.5699 30.0196 20.5485L30.0191 20.5462C30.0132 20.5217 30.0074 20.4973 30.0101 20.4709C30.0601 19.6 30.6101 11.8459 34.7026 7.72589C37.5401 4.87438 42.4701 4.8769 45.3076 7.72338C48.2301 10.673 48.2301 15.4625 45.3076 18.4046C44.4151 19.3005 43.3476 20.0229 42.2201 20.6143ZM35.4401 17.6571C35.9026 15.4348 36.7601 12.772 38.2376 11.2871C38.7076 10.8089 39.3351 10.5497 40.0051 10.5497C40.6751 10.5497 41.3026 10.8089 41.7701 11.2821C42.7451 12.2662 42.7476 13.8618 41.7726 14.8459C40.2951 16.3333 37.6476 17.199 35.4401 17.6571ZM7.50513 35.715V50.8156C7.50513 53.5916 9.74762 55.8492 12.5051 55.8492H27.5051V35.715H7.50513ZM32.5051 35.715V55.8492H47.5051C50.2651 55.8492 52.5051 53.5916 52.5051 50.8156V35.715H32.5051ZM18.2376 11.2846C17.2626 12.2662 17.2626 13.8618 18.2376 14.8459C19.7026 16.3207 22.3676 17.1915 24.5676 17.6521C24.1076 15.4323 23.2476 12.7695 21.7726 11.2846C21.3026 10.8089 20.6751 10.5497 20.0051 10.5497C19.3351 10.5497 18.7076 10.8089 18.2376 11.2846Z"
            fill="white"
            fill-opacity="0.6"
          />
        </svg>

        <svg
          width="22"
          height="22"
          viewBox="0 0 60 60"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            d="M5 4.58484C2.23858 4.58484 0 6.86879 0 9.68619V50.497C0 53.3145 2.23857 55.5983 5 55.5983H55C57.7615 55.5983 60 53.3145 60 50.497V9.68619C60 6.86879 57.7615 4.58484 55 4.58484H5ZM24.4111 28.6836V38.9679C22.2511 40.4065 19.7011 41.2023 16.8511 41.2023C10.2811 41.2023 6.65112 36.7948 6.65112 30.2752C6.65112 23.7251 10.5811 19.2869 16.9711 19.2869C19.5211 19.2869 21.6511 19.8991 23.3011 20.8479L22.6111 25.4086C21.0511 24.3985 19.2211 23.6027 17.0911 23.6027C13.5211 23.6027 11.7811 26.2962 11.7811 30.2446C11.7811 34.2237 13.5811 37.009 17.1511 37.009C18.2911 37.009 19.1011 36.7642 19.9411 36.3356V32.5709H16.0711V28.6836H24.4111ZM28.8703 19.6848H34.0002V40.8044H28.8703V19.6848ZM51.181 19.6848V24.0618H43.891V28.3775H49.651V32.7545H43.891V40.8044H38.791V19.6848H51.181Z"
            fill="white"
            fill-opacity="0.6"
          />
        </svg>

        <svg
          width="20"
          height="20"
          viewBox="0 0 60 60"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
        >
          <g clip-path="url(#clip0_502_7368)">
            <path
              fill-rule="evenodd"
              clip-rule="evenodd"
              d="M30 16.5824V0.664245H6C4.4087 0.664245 2.88258 1.29002 1.75736 2.40391C0.632141 3.5178 0 5.02856 0 6.60384L0 53.9424C0 55.5177 0.632141 57.0285 1.75736 58.1424C2.88258 59.2563 4.4087 59.882 6 59.882H54C55.5913 59.882 57.1174 59.2563 58.2426 58.1424C59.3679 57.0285 60 55.5177 60 53.9424V30.184H43.74C40.1032 30.1607 36.6221 28.7202 34.0504 26.1744C31.4788 23.6286 30.0236 20.1825 30 16.5824ZM30 46.6664C27.3505 46.6664 24.8095 45.6245 22.936 43.7699C21.0625 41.9153 20.01 39.3998 20.01 36.777H24C24 38.3523 24.6321 39.863 25.7574 40.9769C26.8826 42.0908 28.4087 42.7166 30 42.7166C31.5913 42.7166 33.1174 42.0908 34.2426 40.9769C35.3679 39.863 36 38.3523 36 36.777H39.99C39.99 39.3998 38.9375 41.9153 37.064 43.7699C35.1905 45.6245 32.6495 46.6664 30 46.6664ZM36 16.523V2.44612C35.9933 2.05779 36.1051 1.67648 36.3208 1.35203C36.5364 1.02759 36.8459 0.775086 37.2089 0.627528C37.5718 0.479971 37.9712 0.444219 38.355 0.524946C38.7388 0.605673 39.089 0.799122 39.36 1.08002L59.43 20.9183C59.7007 21.194 59.8835 21.5424 59.9557 21.9201C60.0278 22.2979 59.9862 22.6883 59.8359 23.0429C59.6856 23.3974 59.4334 23.7003 59.1105 23.914C58.7876 24.1276 58.4084 24.2425 58.02 24.2445H43.8C42.7746 24.2484 41.7585 24.0513 40.8104 23.6647C39.8622 23.278 39.0008 22.7094 38.2757 21.9916C37.5506 21.2739 36.9762 20.4211 36.5857 19.4825C36.1951 18.5439 35.996 17.5381 36 16.523ZM14.4828 39.398C14.4828 41.6603 12.6301 43.4943 10.3448 43.4943C8.05951 43.4943 6.2069 41.6603 6.2069 39.398C6.2069 37.1357 8.05951 35.3018 10.3448 35.3018C12.6301 35.3018 14.4828 37.1357 14.4828 39.398ZM49.6552 43.4943C51.9405 43.4943 53.7931 41.6603 53.7931 39.398C53.7931 37.1357 51.9405 35.3018 49.6552 35.3018C47.3699 35.3018 45.5172 37.1357 45.5172 39.398C45.5172 41.6603 47.3699 43.4943 49.6552 43.4943Z"
              fill="white"
              fill-opacity="0.6"
            />
          </g>
          <defs>
            <clipPath id="clip0_502_7368">
              <rect width="60" height="60" fill="white" />
            </clipPath>
          </defs>
        </svg>

        <svg
          width="25"
          height="25"
          viewBox="0 0 60 60"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            fill-rule="evenodd"
            clip-rule="evenodd"
            d="M5.00024 30C5.00024 16.1925 16.1927 5 30.0002 5C43.8077 5 55.0002 16.1925 55.0002 30C55.0002 43.805 43.8077 55 30.0002 55C16.1927 55 5.00024 43.805 5.00024 30ZM15.9377 32.1782C18.5266 32.1782 20.6252 30.0795 20.6252 27.4907C20.6252 24.9018 18.5266 22.8032 15.9377 22.8032C13.3489 22.8032 11.2502 24.9018 11.2502 27.4907C11.2502 30.0795 13.3489 32.1782 15.9377 32.1782ZM48.7502 27.4907C48.7502 30.0795 46.6515 32.1782 44.0627 32.1782C41.474 32.1782 39.3752 30.0795 39.3752 27.4907C39.3752 24.9018 41.474 22.8032 44.0627 22.8032C46.6515 22.8032 48.7502 24.9018 48.7502 27.4907ZM26.217 37.0625C25.8942 35.809 24.6165 35.0542 23.3629 35.377C22.1094 35.6995 21.3547 36.9775 21.6774 38.231C22.6312 41.937 25.9927 44.678 30.0002 44.678C34.0077 44.678 37.3692 41.937 38.323 38.231C38.6457 36.9775 37.891 35.6995 36.6375 35.377C35.384 35.0542 34.1062 35.809 33.7835 37.0625C33.3497 38.7477 31.8172 39.9905 30.0002 39.9905C28.1832 39.9905 26.6507 38.7477 26.217 37.0625Z"
            fill="white"
            fill-opacity="0.6"
          />
        </svg>
        <svg
          width="20"
          height="20"
          viewBox="0 0 60 60"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
        >
          <g clip-path="url(#clip0_1734_725)">
            <path
              d="M8.18182 0H19.0909C24.5455 0 27.2727 2.72727 27.2727 8.18182V19.0909C27.2727 24.5455 24.5455 27.2727 19.0909 27.2727H8.18182C2.72727 27.2727 0 24.5455 0 19.0909V8.18182C0 2.72727 2.72727 0 8.18182 0ZM32.7273 13.6364C32.7273 17.253 34.164 20.7214 36.7213 23.2787C39.2786 25.836 42.747 27.2727 46.3636 27.2727C49.9802 27.2727 53.4487 25.836 56.006 23.2787C58.5633 20.7214 60 17.253 60 13.6364C60 10.0198 58.5633 6.55131 56.006 3.994C53.4487 1.43668 49.9802 0 46.3636 0C42.747 0 39.2786 1.43668 36.7213 3.994C34.164 6.55131 32.7273 10.0198 32.7273 13.6364ZM13.6364 32.7273C10.0198 32.7273 6.55131 34.164 3.994 36.7213C1.43668 39.2786 0 42.747 0 46.3636C0 49.9802 1.43668 53.4487 3.994 56.006C6.55131 58.5633 10.0198 60 13.6364 60C17.253 60 20.7214 58.5633 23.2787 56.006C25.836 53.4487 27.2727 49.9802 27.2727 46.3636C27.2727 42.747 25.836 39.2786 23.2787 36.7213C20.7214 34.164 17.253 32.7273 13.6364 32.7273ZM46.3636 32.7273C42.747 32.7273 39.2786 34.164 36.7213 36.7213C34.164 39.2786 32.7273 42.747 32.7273 46.3636C32.7273 49.9802 34.164 53.4487 36.7213 56.006C39.2786 58.5633 42.747 60 46.3636 60C49.9802 60 53.4487 58.5633 56.006 56.006C58.5633 53.4487 60 49.9802 60 46.3636C60 42.747 58.5633 39.2786 56.006 36.7213C53.4487 34.164 49.9802 32.7273 46.3636 32.7273Z"
              fill="#949BA4"
            />
          </g>
          <defs>
            <clipPath id="clip0_1734_725">
              <rect width="60" height="60" fill="white" />
            </clipPath>
          </defs>
        </svg>
      </div>
    </div>
  );
}
